---
title: 性能优化的指标和工具
date: 2021-07-22 17:28:23
permalink: /pages/a59e26/
categories:
  - 体系课程
  - 性能优化
tags:
  - 
---
#  为什么要进行Web性能优化

## 性能- web网站和应用的支柱

![image-20210713110238894](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713110238.png)

## 寻找性能瓶颈

- 了解性能指标- 多快才算快
- 利用测量工具和apis
- 优化问题，重新测试（迭代）永无止境

## 移动端挑战多

![image-20210713110508039](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713110508.png)

# 性能指标和优化目标

## 淘宝首页例子

![image-20210713110813418](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713110813.png)

## 瀑布流

- 纵向对比，让合适资源并行加载

- 横向对比，减缓资源加载过程

![横向对比](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713111535.png)![image-20210713111306485](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713111306.png)

## LIghthouse

![image-20210713112129082](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713112129.png)

## frames per second(FPS)

![image-20210713112245487](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713112245.png)

![image-20210713113110610](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713113110.png)

## 异步请求 1s内请求回来

## 性能优化- 加载

- 理解加载瀑布图（横向 纵向）
- 基于HAR存储于重建性能信息（右击保存当前控制台信息的那个）
- 速度指数（speed Index）4s
- 重要测量指标
  - Speed Index 
  - TTPB 发送请求到请求回来的时间
  - 页面加载时间
  - 首次渲染 First Contentful Paint

## 性能优化- 响应

- 交互动画的反馈时间
- 帧率FPS 60帧以上
- 异步请求的完成时间 1s内 超过的加loading

#  RAIL测量模型【黄金指南】

## 什么是RAIL

- Response
  - 并不是请求发送给服务器的那个
  - 指的是 当用户与网站进行交互的时候，有没有及时给用户反馈
- Animation 动画
  - 动画是否足够流畅
- Idle 空闲
  - 浏览器要有足够的空闲 来及时给用户反馈
  - ![image-20210713114323406](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713114323.png)
- Load加载
  - 资源网络加载的时间

## RAIL评估标准

- 响应：处理事件应在50ms以内完成

![image-20210713171255721](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713171255.png)

- 动画：每10ms产生1帧
- 空闲：尽可能增加空闲时间
- 加载：在5S内完成内容加载并可以交互

## 性能测量工具

- Chrome DevTools 开发调试、性能评测
- Lighthouse 网站整体质量评估
- webPageTest 多测试地点、全面性能报告

# 使用WebPageTest评估Web网站性能

- webpagetest.org[https://webpagetest.org/]

![image-20210713171911138](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713171911.png)

![image-20210713172137232](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713172137.png)

## 解读webpageTest 的报告

- waterfall chart 请求瀑布图
- first view 首次访问
- repeat view 二次访问

![image-20210713173027080](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713173027.png)![image-20210713172938112](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713172938.png)![image-20210713172919770](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210713172919.png)

## webPageTest 本地部署

### 扩展知识：Docker 安装 也有安装包

1. 访问Docker官网文档，按需下载对应版本安装
   `https://docs.docker.com/get-docker/`

2. 注册docker id
   `https://hub.docker.com/signup`

3. 安装后点击工具栏的Docker图标，使用注册的docker id登录

### 使用官方docker镜像  server 和agent

![image-20210714093209995](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093210.png)

![image-20210714093232763](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093232.png)

### 运行一个sever实例

![image-20210714093300149](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093300.png)

### 运行agent实例 注意实例

![image-20210714093334669](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093334.png)

## 创建server自定义镜像

### 创建dockerfile 并添加

![image-20210714093507317](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093507.png)

![image-20210714093553876](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093553.png)

### 创建localtions.ini 并添加配置

![image-20210714093829235](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093829.png)

![image-20210714093808978](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093809.png)

### build

![image-20210714093918981](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714093919.png)

### 运行我们自定义的镜像

![image-20210714094110485](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714094110.png)

## WebPageTest本地部署说明

1. 拉取镜像

   ```
   docker pull webpagetest/server
   
   docker pull webpagetest/agent
   ```

2. 运行实例

   ```
   docker run -d -p 4000:80 --rm webpagetest/server
   
   docker run -d -p 4001:80 --network="host" -e "SERVER_URL=http://localhost:4000/work/" -e "LOCATION=Test" webpagetest/agent
   ```

## mac 用户自定义镜像

1. 创建server目录

   ```
   mkdir wpt-mac-server
   cd wpt-mac-server
   ```

2. 创建Dockerfile，添加内容

   ```
   vim Dockerfile
   
   FROM webpagetest/server
   ADD locations.ini /var/www/html/settings/
   ```

3. 创建locations.ini配置文件，添加内容

   ```
   vim locations.ini
   
   [locations]
   1=Test_loc
   [Test_loc]
   1=Test
   label=Test Location
   group=Desktop
   [Test]
   browser=Chrome,Firefox
   label="Test Location"
   connectivity=LAN
   ```

4. 创建自定义server镜像

   ```
   docker build -t wpt-mac-server .
   ```

5. 创建agent目录

   ```
   mkdir wpt-mac-agent
   cd wpt-mac-agent
   ```

6. 创建Dockerfile，添加内容

   ```
   vim Dockerfile
   
   FROM webpagetest/agent
   ADD script.sh /
   ENTRYPOINT /script.sh
   ```

7. 创建script.sh， 添加内容

   ```
   vim script.sh
   
   #!/bin/bash
   set -e
   if [ -z "$SERVER_URL" ]; then
     echo >&2 'SERVER_URL not set'
     exit 1
   fi
   if [ -z "$LOCATION" ]; then
     echo >&2 'LOCATION not set'
     exit 1
   fi
   EXTRA_ARGS=""
   if [ -n "$NAME" ]; then
     EXTRA_ARGS="$EXTRA_ARGS --name $NAME"
   fi
   python /wptagent/wptagent.py --server $SERVER_URL --location $LOCATION $EXTRA_ARGS --xvfb --dockerized -vvvvv --shaper none
   ```

8. 修改script.sh权限

   ```
   chmod u+x script.sh
   ```

9. 创建自定义agent镜像

   ```
   docker build -t wpt-mac-agent .
   ```

10. 用新镜像运行实例 (注意先停掉之前运行的containers)

    ```
       docker run -d -p 4000:80 --rm wpt-mac-server
       
    ```

   docker run -d -p 4001:80 --network="host" -e "SERVER_URL=http://localhost:4000/work/" -e "LOCATION=Test" wpt-mac-agent

    ```   
    
    ```

# 使用LightHouse分析性能

## npm 安装使用方式

- 安装`npm install -g lighthouse`
- 使用`lighthouse 目标地址`
- 结果会生成一个本地报告的网页
- ![image-20210714094531501](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714094531.png)

![image-20210714094726426](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714094726.png)

![image-20210714094857039](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714094857.png)

## 直接在Chrome里使用就行了

#  使用Chrome DevTools分析性能【最大法宝】

## 请求大小与实际访问大小一致 可以在server中进行压缩

```js
app.use(compression());
app.use(express.static('build'));

```

```js
const express = require('express');
const app = express();
const fs = require('fs');
const compression = require('compression');
const path = require('path');


app.use(compression());
app.use(express.static('build'));

app.get('*', (req,res) =>{
    res.sendFile(path.join(__dirname+'/build/index.html'));
});

const listener = app.listen(process.env.PORT || 3000, function () {
    console.log(`Listening on port ${listener.address().port}`);
});

```

![image-20210714100214563](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714100214.png)

![image-20210714100231974](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714100232.png)

![image-20210714101420500](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714101420.png)

# 常用的性能测量APIs

- 关键时间节点（`Navigation Timing , Resource Timing`）
- 网络状态（`Network APIs`）
- 客户端服务端协商（`HTTP Client Hints`）
- 网页显示状态（`UI APIs`）

## 常用apis计算方式

- DNS 解析耗时: domainLookupEnd - domainLookupStart
- TCP 连接耗时: connectEnd - connectStart
- SSL 安全连接耗时: connectEnd - secureConnectionStart
- 网络请求耗时 (TTFB): responseStart - requestStart
- 数据传输耗时: responseEnd - responseStart
- DOM 解析耗时: domInteractive - responseEnd
- 资源加载耗时: loadEventStart - domContentLoadedEventEnd
- First Byte时间: responseStart - domainLookupStart
- 白屏时间: responseEnd - fetchStart
- 首次可交互时间: domInteractive - fetchStart
- DOM Ready 时间: domContentLoadEventEnd - fetchStart
- 页面完全加载时间: loadEventStart - fetchStart
- http 头部大小： transferSize - encodedBodySize
- 重定向次数：performance.navigation.redirectCount
- 重定向耗时: redirectEnd - redirectStart

## Time to Interactive

```js
// 计算一些关键的性能指标
window.addEventListener('load', (event) => {
    // Time to Interactive
    let timing = performance.getEntriesByType('navigation')[0];
    console.log(timing.domInteractive);
    console.log(timing.fetchStart);
    let diff = timing.domInteractive - timing.fetchStart;
    console.log("TTI: " + diff);
})
```
![image-20210714102520219](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714102520.png)

##  观察长任务

```js
// 观察长任务
// 通过观察者
const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        console.log(entry)
    }
})
//监听一个类型 这边我们要看长任务
observer.observe({entryTypes: ['longtask']})
```
![image-20210714102838946](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714102839.png)

## 见面可见性的状态监听

判断当前用户是否在看页面或者使用页面  

```js
// 见面可见性的状态监听
let vEvent = 'visibilitychange';
if (document.webkitHidden != undefined) {
    // webkit prefix detected 
    //webki事件名称
    vEvent = 'webkitvisibilitychange';
}

function visibilityChanged() {
    //页面不可见
    if (document.hidden || document.webkitHidden) {
        console.log("Web page is hidden.")
    } else {
        //页面可见
        console.log("Web page is visible.")
    }
}
// 时间监听 (事件，回调)
document.addEventListener(vEvent, visibilityChanged, false);
```

![image-20210714103426451](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714103426.png)

## 判断当前用户网络状态

```js
var connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
var type = connection.effectiveType;
//监听事件的回调
function updateConnectionStatus() {
  console.log("Connection type changed from " + type + " to " + connection.effectiveType);
  type = connection.effectiveType;
}
//监听
connection.addEventListener('change', updateConnectionStatus);
```

![image-20210714103801617](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210714103801.png)
