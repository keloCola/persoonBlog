---
title: 装饰器模式
date: 2021-07-25 23:10:00
permalink: /pages/2cdb1d/
categories:
  - 体系课程
  - js设计模式
tags:
  - 
---
# 第7章 装饰器模式

装饰器模式属于`结构型模式`，它是作为现有的类的一个包装，允许向一个现有的对象添加新的功能，同时又不改变其结构。本章同样介绍概念、UML。同时使用了丰富/实用的场景示例，包括ES7装饰器、core-decorators模块等

## 7-1 装饰器模式-介绍

- 为对象添加新功能
- 不改变其原有的结构和功能

::: tip

- 适配器：原来的旧接口不用了
- 装饰器：原来的旧接口还要接着用，又要新增功能

:::

![image-20210724223611031](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210724223611.png)
<!-- more -->
## 传统UML类图

![image-20210724224045033](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210724224045.png)

## 简化后的UML类图

![image-20210724224311598](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210724224311.png)

## 代码演示

::: details

```js
class Circle{
  draw(){
    console.log('画一个圆形');
  }
}

class Decorator{
  constructor(circle){
    this.circle = circle
  }
  draw(){
    this.circle.draw()
    this.setRedBorder(circle)
  }
  setRedBorder(circle){
    console.log('设置红色边框');
  }
}

// 测试代码
let circle = new Circle()
circle.draw()
console.log('-----分割线----');
let dec = new Decorator(circle)
dec.draw()
```



:::

![image-20210724224642037](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210724224642.png)

## 7-2 装饰器模式-场景1 ES7装饰器

- 第三方的库：core-decorator

### 配置环境

![image-20210724225612383](https://gitee.com/sheep101/typora-img-save/raw/master/img/20210724225612.png)

`npm install babel-plugin-transform-decorators-legacy  --save-dev`

```js
//.babelrc文件
{
    "presets": ["es2015", "latest"],
    "plugins": ["transform-decorators-legacy"]
}
```

装饰器在es7中是直接`@ fun`

```js {1,8}
@ testDec
class Demo{
    
}
function testDec(target){
    target.isDec=true
}
alert(Demo.isDec)//弹出框 并显示 true
```



### 装饰类-装饰器的原理

对class进行一个装饰

```js
//装饰器的原理

@decorator
class A {}

//等同于

class A {}
A = decorator(A)||A;
```

>换句话说就是A在decorator中执行一遍 后 返回值

### 装饰类-可加参数

```js {3-5,8}
function testDec(isDec){
    return function(target){
        target.isDec = isDec
    }
}

@ testDec(true)
class Demo{
    //...
}

alert(Demo.isDec)//弹出框 并显示 true
```

### 装饰类-mixin示例

```js
function mixins(...list) {
  return function (target) {
    Object.assign(target.prototype, ...list)
  }
}

const Foo = {
  foo() { alert('foo') }
}

@mixins(Foo)
class MyClass { }

let obj = new MyClass();
obj.foo() // 'foo'
```



### 装饰方法- readonly

```js {9,19,25}
function readonly(target, name, descriptor){
  // descriptor对象原来的值如下
  // {
  //   value: specifiedFunction,
  //   enumerable: false,
  //   configurable: true,
  //   writable: true
  // };
  descriptor.writable = false;
  return descriptor;
}

class Person {
    constructor() {
        this.first = 'A'
        this.last = 'B'
    }

    @readonly
    name() { return `${this.first} ${this.last}` }
}

var p = new Person()
console.log(p.name())
p.name = function () {} // 这里会报错，因为 name 是只读属性
```

### 装饰方法- log

```js
function log(target, name, descriptor) {
  var oldValue = descriptor.value;

  descriptor.value = function() {
    console.log(`Calling ${name} with`, arguments);
    return oldValue.apply(this, arguments);
  };

  return descriptor;
}

class Math {
  // 装饰方法
  @log
  add(a, b) {
    return a + b;
  }
}

const math = new Math();
const result = math.add(2, 4);//执行add 时，会自动打印日志，因为有@log装饰器
console.log('result', result);
```

## core-decorators

- 第三方开源lib

- 提供常用的装饰器

- [查阅文档](https://github.com/jayphelps/core-decorators)

  安装`npm i core-decorators --save-dev`

### **readonly**

```js
import { readonly } from 'core-decorators'

class Person {
    @readonly
    name() {
        return 'zhang'
    }
}

let p = new Person()
alert(p.name())
// p.name = function () { /*...*/ }  // 此处会报错
```

### deprecate

```js
import { deprecate } from 'core-decorators';//废弃的意思

class Person {
  @deprecate
  facepalm() {}

  @deprecate('We stopped facepalming')
  facepalmHard() {}

  @deprecate('We stopped facepalming', { url: 'http://knowyourmeme.com/memes/facepalm' })
  facepalmHarder() {}
}

let person = new Person();

person.facepalm();
// DEPRECATION Person#facepalm: This function will be removed in future versions.

person.facepalmHard();
// DEPRECATION Person#facepalmHard: We stopped facepalming

person.facepalmHarder();
// DEPRECATION Person#facepalmHarder: We stopped facepalming
//
//     See http://knowyourmeme.com/memes/facepalm for more details.
```

## 设计原则验证

- 将现有对象和装饰器进行分离，两者独立存在
- 符合开放封闭原则